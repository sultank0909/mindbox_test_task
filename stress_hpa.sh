#!/bin/bash

# EXTERNAL-IP твоего сервиса
TARGET="http://34.41.114.166"

echo "=== Запуск экстремальной нагрузки на $TARGET ==="

# Параллельно запускаем hey для создания большой нагрузки
# -z 10m : 10 минут
# -c 1000 : 1000 параллельных клиентов
# -q 5000 : 5000 запросов в секунду на клиента (очень агрессивно!)
# Используем & для фонового запуска
hey -z 10m -c 1000 -q 5000 $TARGET &

# PID процесса hey, чтобы можно было завершить позже
PID_HEY=$!

# Параллельно наблюдаем за HPA и подами
echo "=== Наблюдение за HPA ==="
kubectl get hpa -w &
PID_HPA=$!

echo "=== Наблюдение за подами ==="
kubectl get pods -o wide --watch &
PID_PODS=$!

# Ждём завершения нагрузки
wait $PID_HEY

# После завершения нагрузки убиваем наблюдения
kill $PID_HPA
kill $PID_PODS

echo "=== Тест завершен ==="
